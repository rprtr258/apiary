name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # v0.0.0, v0.1.0, v1.0.0, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.1.0)'
        required: true
        default: '0.0.0-test'

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for release notes

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.5'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('frontend/bun.lock', 'frontend/package.json') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build frontend
        run: cd frontend && bun run build

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev

      - name: Build Wails app
        run: |
          wails build \
            -platform "linux/amd64" \
            -ldflags="-X 'github.com/rprtr258/apiary/internal/version.Version=${{ steps.version.outputs.version }}' \
                      -X 'github.com/rprtr258/apiary/internal/version.Commit=${{ github.sha }}' \
                      -X 'github.com/rprtr258/apiary/internal/version.Date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')'" \
            -o "apiary-linux-amd64"

      - name: Verify binary
        run: |
          cd build/bin
          ls -la
          file apiary-linux-amd64
          ./apiary-linux-amd64 --version 2>&1 | head -5 || true

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v6
        with:
          name: apiary-linux-amd64
          if-no-files-found: "error"
          path: build/bin/apiary-linux-amd64

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        platform:
          - darwin/amd64
          - darwin/arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.5'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('frontend/bun.lock', 'frontend/package.json') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build frontend
        run: cd frontend && bun run build

      - name: Build Wails app for macOS
        run: |
          wails build \
            -platform "${{ matrix.platform }}" \
            -ldflags="-X 'github.com/rprtr258/apiary/internal/version.Version=${{ steps.version.outputs.version }}' \
                      -X 'github.com/rprtr258/apiary/internal/version.Commit=${{ github.sha }}' \
                      -X 'github.com/rprtr258/apiary/internal/version.Date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"

      - name: Checkout create-image
        uses: actions/checkout@v6
        with:
          repository: create-dmg/create-dmg
          path: ./build/create-dmg
          ref: master

      - name: Normalise platform tag
        id: normalise_platform
        shell: bash
        run: |
          tag=$(echo ${{ matrix.platform }} | sed -e 's/\//_/g')
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Build macOS DMG
        shell: bash
        working-directory: ./build
        run: |
          ./create-dmg/create-dmg \
            --no-internet-enable \
            --volname "apiary" \
            --volicon "bin/apiary.app/Contents/Resources/iconfile.icns" \
            --text-size 12 \
            --window-pos 400 400 \
            --window-size 660 450 \
            --icon-size 80 \
            --icon "apiary.app" 180 180 \
            --hide-extension "apiary.app" \
            --app-drop-link 480 180 \
            "bin/apiary-${{ steps.normalise_platform.outputs.tag }}.dmg" \
            "bin"

      - name: Get arch
        id: platform_arch
        shell: bash
        run: |
          tag=$(echo ${{ matrix.platform }} | cut -d'/' -f2)
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Rename dmg
        working-directory: ./build/bin
        run: mv "apiary-${{ steps.normalise_platform.outputs.tag }}.dmg" "apiary-darwin-${{ steps.platform_arch.outputs.tag }}.dmg"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v6
        with:
          name: apiary-darwin-${{ steps.platform_arch.outputs.tag }}
          if-no-files-found: "error"
          path: build/bin/apiary-darwin-${{ steps.platform_arch.outputs.tag }}.dmg

  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            echo "version=${{ github.event.inputs.version }}" >> $env:GITHUB_OUTPUT
          } else {
            $tag = "${{ github.ref }}"
            $version = $tag -replace 'refs/tags/v', ''
            echo "version=$version" >> $env:GITHUB_OUTPUT
          }

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.5'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('frontend/bun.lock', 'frontend/package.json') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build frontend
        run: cd frontend && bun run build

      - name: Build Wails app for Windows
        run: |
          $buildDate = (Get-Date -AsUTC -Format 'yyyy-MM-ddTHH:mm:ssZ')
          wails build `
            -platform "windows/amd64" `
            -ldflags="-X 'github.com/rprtr258/apiary/internal/version.Version=${{ steps.version.outputs.version }}' `
                      -X 'github.com/rprtr258/apiary/internal/version.Commit=${{ github.sha }}' `
                      -X 'github.com/rprtr258/apiary/internal/version.Date=$buildDate'" `
            -o "apiary-windows-amd64.exe"

      - name: Upload Windows artifact
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: apiary-windows-amd64
          if-no-files-found: "error"
          path: build/bin/apiary-windows-amd64.exe

  release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required for creating releases

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Check artifact existence
        id: check-artifacts
        run: |
          echo "Checking for required artifacts..."

          # Check for Linux artifact
          if [[ -f "artifacts/apiary-linux-amd64/apiary-linux-amd64" ]]; then
            echo "Linux artifact found"
            LINUX_FOUND=true
          else
            echo "Linux artifact NOT found"
            LINUX_FOUND=false
          fi

          # Check for macOS artifacts
          if [[ -d "artifacts/apiary-darwin-amd64" ]] && [[ -d "artifacts/apiary-darwin-arm64" ]]; then
            echo "macOS artifacts found"
            MACOS_FOUND=true
          else
            echo "macOS artifacts NOT found"
            MACOS_FOUND=false
          fi

          # Check for Windows artifact (optional due to continue-on-error)
          if [[ -f "artifacts/apiary-windows-amd64/apiary-windows-amd64.exe" ]]; then
            echo "Windows artifact found"
            WINDOWS_FOUND=true
          else
            echo "Windows artifact NOT found"
            WINDOWS_FOUND=false
          fi

          # Require at least Linux and macOS artifacts
          if [[ "$LINUX_FOUND" == "true" ]] && [[ "$MACOS_FOUND" == "true" ]] && [[ "$WINDOWS_FOUND" == "true" ]]; then
            echo "Required artifacts present"
            echo "artifacts_ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ERROR: Missing required artifacts"
            ls artifacts/ artifacts/*
            echo "artifacts_ok=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: List artifacts
        if: steps.check-artifacts.outputs.artifacts_ok == 'true'
        run: find artifacts -type f

      - name: Extract version for release
        if: steps.check-artifacts.outputs.artifacts_ok == 'true'
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
            echo "tag_name=v${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
            echo "tag_name=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Release
        if: steps.check-artifacts.outputs.artifacts_ok == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: ${{ steps.version.outputs.tag_name }}
          generate_release_notes: true
          files: |
            artifacts/**/apiary-*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-test') || contains(steps.version.outputs.version, '-rc') || contains(steps.version.outputs.version, '-beta') || contains(steps.version.outputs.version, '-alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
